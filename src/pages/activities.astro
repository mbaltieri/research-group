---
import Layout from "~/layouts/PageLayout.astro";
import Headline from '~/components/blog/Headline.astro';

// Activities (grid) data + component
import { loadActivities } from "~/lib/activities";
import ActivitiesGrid from "~/components/activities/ActivitiesGrid.astro";

// Talks (already implemented in your project)
import { loadTalks } from '~/lib/talks';
import TalksList from '~/components/talks/TalksList.astro';

// Load data
const { groups } = await loadActivities();

const { years: talkYears, groups: talkGroups, members: talkMembers } = await loadTalks();
const member = Astro.url.searchParams.get('member') ?? undefined;
---

<Layout>
  <section class="px-6 sm:px-6 py-12 sm:py-16 lg:py-20 mx-auto max-w-7xl">
    <Headline>Activities</Headline>

    <ActivitiesGrid {groups} />

    <div class="mb-12 pt-12 mt-12 border-t border-white/10"></div>

    <h2
      class="mb-4 text-xl font-semibold
             intersect-once intersect-quarter intersect-no-queue
             motion-safe:md:opacity-0 motion-safe:md:intersect:animate-fade"
      style="animation-delay:140ms"
      id="talks"
    >
      Presentations, Panels and other Events
    </h2>

    {talkMembers.length > 0 && (
      <div
        class="mb-6 flex flex-wrap gap-2 text-sm
               intersect-once intersect-quarter intersect-no-queue
               motion-safe:md:opacity-0 motion-safe:md:intersect:animate-fade"
        style="animation-delay:150ms"
      >
        <a href="/activities#talks" class="rounded-full border px-3 py-1 hover:bg-white/10">All</a>
        {talkMembers.map(m => (
          <a href={`/activities?member=${encodeURIComponent(m)}#talks`} class="rounded-full border px-3 py-1 hover:bg-white/10">
            {m}
          </a>
        ))}
      </div>
    )}

    <TalksList years={talkYears} groups={talkGroups} filterBy={member} />

    <div
      class="mt-14 rounded-2xl border border-dashed border-border/60 p-6 text-sm text-muted-foreground
             intersect-once intersect-quarter intersect-no-queue
             motion-safe:md:opacity-0 motion-safe:md:intersect:animate-fade"
      style="animation-delay:160ms"
    />
  </section>

  <script is:inline>
    (function () {
      function attachFade() {
        const imgs = document.querySelectorAll('img[data-fade]');
        for (const img of imgs) {
          if (img.dataset.fadeBound) continue;
          img.dataset.fadeBound = 'true';
          const show = () => img.classList.remove('opacity-0');
          if (img.complete) {
            requestAnimationFrame(show);
          } else {
            img.addEventListener('load', show, { once: true });
            img.addEventListener('error', show, { once: true });
          }
        }
      }
      attachFade();
      document.addEventListener('astro:page-load', attachFade);
      document.addEventListener('astro:after-swap', attachFade);
    })();
  </script>

  <script is:inline>
    (() => {
      const q = '[class*="intersect-"],[class*="intersect:"]';
      let io = null;

      function init() {
        const els = Array.from(document.querySelectorAll(q))
          .filter(el => !el.dataset.intersectBound);
        if (!els.length) return;

        if (!io) {
          io = new IntersectionObserver((entries) => {
            for (const e of entries) {
              if (!e.isIntersecting) continue;
              const el = e.target;
              el.classList.add('intersect');
              if (el.classList.contains('intersect-once')) io.unobserve(el);
            }
          }, { threshold: 0.25, rootMargin: '0px 0px -10% 0px' });
        }

        for (const el of els) {
          el.dataset.intersectBound = '1';
          io.observe(el);
        }
      }

      init();
      document.addEventListener('astro:page-load', init);
      document.addEventListener('astro:after-swap', init);
    })();
  </script>
</Layout>
