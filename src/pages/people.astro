---
import { getCollection } from "astro:content";
import PageLayout from "~/layouts/PageLayout.astro";
import CallToAction from '~/components/widgets/CallToAction.astro';
import Headline from '~/components/blog/Headline.astro';
import { ORDERED_GROUPS } from '~/roles.ts';

// Grab every image in src/assets/images/people and get their resolved URL
const peopleImages = import.meta.glob("~/assets/images/people/*.{jpg,jpeg,png,webp,svg}", {
  eager: true,
  import: "default",
});

function resolveImagePath(path) {
  if (!path) return null;
  const filename = path.split("/").pop();
  const entry = Object.entries(peopleImages).find(([p]) => p.endsWith("/" + filename));
  return entry ? (entry[1].src ?? entry[1]) : null;
}

const people = await getCollection("people");

// Group and sort
const grouped = ORDERED_GROUPS.map((group) => ({
  label: group,
  people: people
    .filter((p) => p.data.group === group)
    .sort(
      (a, b) =>
        (a.data.order ?? 999) - (b.data.order ?? 999) ||
        a.data.name.localeCompare(b.data.name)
    ),
})).filter((g) => g.people.length > 0);
---

<PageLayout title="People">
  <!-- <section class="mx-auto max-w-7xl px-6 py-16"> -->
  <!--   <h1 -->
  <!--     class="mb-10 text-4xl font-bold tracking-tight -->
  <!--            intersect-once intersect-quarter intersect-no-queue -->
  <!--            motion-safe:md:opacity-0 motion-safe:md:intersect:animate-fade" -->
  <!--     style="animation-delay:120ms" -->
  <!--   > -->
  <!-- </h1> -->
  <section class="px-6 sm:px-6 py-12 sm:py-16 lg:py-20 mx-auto max-w-7xl">
    <Headline>
      Our Team
    </Headline>

    <nav
      class="mb-10 flex flex-wrap gap-3 text-sm opacity-90
             intersect-once intersect-quarter intersect-no-queue
             motion-safe:md:opacity-0 motion-safe:md:intersect:animate-fade"
      style="animation-delay:180ms"
    >
      <!-- {grouped.map((g) => ( -->
      <!--   <a -->
      <!--     href={`#${g.label.toLowerCase()}`} -->
      <!--     class="rounded-full border dark:border-white/10 px-3 py-1 hover:bg-white/10" -->
      <!--   > -->
      <!--     {g.label} -->
      <!--   </a> -->
      <!-- ))} -->
    </nav>

    {grouped.map((g, idx) => (
      <section
        id={g.label.toLowerCase()}
        class={idx > 0 ? "mt-12 border-t border-white/10 pt-12" : ""}
      >
        <h2
          class="mb-6 text-2xl font-semibold tracking-tight
                 intersect-once intersect-quarter intersect-no-queue
                 motion-safe:md:opacity-0 motion-safe:md:intersect:animate-fade"
          style="animation-delay:140ms"
        >
          {g.label}
        </h2>

        <div class="grid gap-8 sm:grid-cols-2 lg:grid-cols-3">
          {g.people.map(({ data }, i) => {
            const resolved = resolveImagePath(data.image);
            const delay = Math.min(i * 70 + 100, 500); // small stagger
            return (
              <article
                class="
                  group rounded-2xl border border-[#ffffff29] dark:border-white/10
                  bg-white/80 dark:bg-slate-900/80
                  p-6 backdrop-blur shadow-[0_4px_30px_rgba(0,0,0,0.1)]
                  transition hover:shadow-lg hover:-translate-y-0.5
                  intersect-once intersect-quarter intersect-no-queue
                  motion-safe:md:opacity-0 motion-safe:md:intersect:animate-fade
                "
                style={`animation-delay:${delay}ms`}
              >
                <div class="flex items-center gap-4">
                  {resolved ? (
                    <img
                      src={resolved}
                      alt={data.name}
                      width="80"
                      height="80"
                      loading="lazy"
                      decoding="async"
                      data-fade
                      class="h-20 w-20 rounded-xl object-cover opacity-0 transition-opacity duration-700 ease-out will-change-[opacity]"
                    />
                  ) : (
                    <div class="h-20 w-20 rounded-xl bg-white/10" />
                  )}
                  <div class="min-w-0">
                    <h3 class="text-xl font-semibold truncate">{data.name}</h3>
                    {data.role && (
                      <p class="text-sm opacity-80">{data.role}</p>
                    )}
                  </div>
                </div>

                {data.bio && (
                  <p class="mt-4 text-sm leading-6 opacity-90">{data.bio}</p>
                )}

                <div class="mt-5 flex flex-wrap items-center gap-3 text-sm opacity-90">
                  {data.website && (
                    <a href={data.website} class="underline hover:no-underline">
                      Website
                    </a>
                  )}
                  {data.github && (
                    <a
                      href={`https://github.com/${data.github}`}
                      class="underline hover:no-underline"
                    >
                      GitHub
                    </a>
                  )}
                  {data.twitter && (
                    <a
                      href={`https://twitter.com/${data.twitter}`}
                      class="underline hover:no-underline"
                    >
                      X
                    </a>
                  )}
                  {data.email && (
                    <a
                      href={`mailto:${data.email}`}
                      class="underline hover:no-underline"
                    >
                      Email
                    </a>
                  )}
                </div>
              </article>
            );
          })}
        </div>
      </section>
    ))}
  </section>

  <CallToAction
    actions={[
      {
        variant: 'primary',
        text: 'Research Careers',
        href: 'https://github.com/arthelokyo/astrowind',
        target: '_blank',
        icon: 'tabler:jump-rope',
      },
    ]}
  >
    <Fragment slot="title">
      Join us
    </Fragment>
  </CallToAction>

  <!-- SPA-safe image fade-in, same as grants -->
  <script is:inline>
    (function () {
      function attachFade() {
        const imgs = document.querySelectorAll('img[data-fade]');
        for (const img of imgs) {
          if (img.dataset.fadeBound) continue;
          img.dataset.fadeBound = 'true';
          const show = () => img.classList.remove('opacity-0');
          if (img.complete) {
            requestAnimationFrame(show); // cached
          } else {
            img.addEventListener('load', show, { once: true });
            img.addEventListener('error', show, { once: true }); // ensure visible on error
          }
        }
      }
      attachFade();
      document.addEventListener('astro:page-load', attachFade);
      document.addEventListener('astro:after-swap', attachFade);
    })();
  </script>
</PageLayout>

