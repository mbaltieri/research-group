---
import { getCollection } from 'astro:content';
import PageLayout from '~/layouts/PageLayout.astro';
import Headline from '~/components/blog/Headline.astro';

const pubs = await getCollection('publications');

// Helpers
const toTime = (s?: string) => {
  const t = s ? new Date(s).getTime() : 0;
  return Number.isNaN(t) ? 0 : t;
};
const toYear = (y: unknown) =>
  typeof y === 'number' ? y : parseInt(String(y ?? '0'), 10) || 0;

function authorLine(authors?: unknown) {
  if (!authors) return '';
  if (Array.isArray(authors)) return authors.join(', ');
  if (typeof authors === 'string') return authors;
  try {
    return String(authors);
  } catch {
    return '';
  }
}

function toStringArray(v?: unknown): string[] {
  if (!v) return [];
  if (Array.isArray(v)) return v.filter(Boolean).map(String);
  if (typeof v === 'string') {
    return v.split(',').map((s) => s.trim()).filter(Boolean);
  }
  return [];
}

// Accept either a DOI string/URL or any fallback URL (e.g., OpenReview)
function doiLikeUrl(doi?: string, url?: string) {
  const v =
    (typeof doi === 'string' && doi.trim()) ||
    (typeof url === 'string' && url.trim()) ||
    '';
  if (!v) return null;
  return /^https?:\/\//i.test(v) ? v : 'https://doi.org/' + v;
}

function arxivUrl(id?: string) {
  if (!id) return null;
  return /^https?:\/\//i.test(id) ? id : 'https://arxiv.org/abs/' + id;
}

// Group by numeric year
const byYear = new Map<number, typeof pubs>();
for (const p of pubs) {
  const y = toYear(p.data.year);
  if (!byYear.has(y)) byYear.set(y, []);
  byYear.get(y)!.push(p);
}

// Sort each year's items by reverse number (highest first)
for (const list of byYear.values()) {
  list.sort((a, b) => {
    const na = Number(a.data.number ?? 0);
    const nb = Number(b.data.number ?? 0);
    return nb - na;
  });
}

// Order years by the most recent addedAt (fallback to calendar year)
const years = Array.from(byYear.keys()).sort((ya, yb) => {
  const la = Math.max(...byYear.get(ya)!.map((e) => toTime(e.data.addedAt)), 0);
  const lb = Math.max(...byYear.get(yb)!.map((e) => toTime(e.data.addedAt)), 0);
  if (lb !== la) return lb - la;
  return yb - ya;
});
---

<PageLayout title="Publications">
  <!-- <section class="pubs mx-auto max-w-7xl px-6 py-16"> -->
  <!--   <h1 -->
  <!--     class="mb-6 text-4xl font-bold tracking-tight -->
  <!--            intersect-once intersect-quarter intersect-no-queue -->
  <!--            motion-safe:md:opacity-0 motion-safe:md:intersect:animate-fade" -->
  <!--     style="animation-delay:120ms" -->
  <!--   > -->
  <!--     Publications -->
  <!--   </h1> -->
  <section class="pubs px-6 sm:px-6 py-12 sm:py-16 lg:py-20 mx-auto max-w-7xl">
    <!-- <Headline -->
    <!--   subtitle="Find us also on Google Scholar" -->
    <!-- > -->
    <!--   Publications -->
    <!-- </Headline> -->
    <Headline>
      Publications
      <Fragment slot="subtitle">
        Find us also on <a href="https://scholar.google.co.jp/citations?user=jDmnwwEAAAAJ&hl" target="_blank" class="hover:text-primary">Google Scholar</a>
      </Fragment>
    </Headline>

    <!-- Year quick-jump -->
    <nav
      class="mb-10 flex flex-wrap gap-3 text-sm opacity-90
             intersect-once intersect-quarter intersect-no-queue
             motion-safe:md:opacity-0 motion-safe:md:intersect:animate-fade"
      style="animation-delay:180ms"
    >
      {years.map((y) => (
        <a
          href={`#y-${y}`}
          class="rounded-full border dark:border-white/10 px-3 py-1 hover:bg-white/10"
          >{y}</a
        >
      ))}
    </nav>

    {years.map((y, idx) => (
      <section
        id={`y-${y}`}
        class={idx > 0 ? 'pt-12 mt-12 border-t border-white/10' : ''}
      >
        <h2
          class="mb-6 text-2xl font-semibold tracking-tight
                 intersect-once intersect-quarter intersect-no-queue
                 motion-safe:md:opacity-0 motion-safe:md:intersect:animate-fade"
          style="animation-delay:140ms"
        >
          {y}
        </h2>

        <ul class="space-y-6">
          {byYear.get(y)!.map(({ data }, i) => {
            const links = {
              doi: doiLikeUrl(data.doi, data.url),
              arxiv: arxivUrl(data.arxiv),
              pdf: data.pdf,
              code: data.code,
              slides: data.slides,
              poster: data.poster,
            };

            const hasDetails =
              Boolean(data.abstract) ||
              Boolean(
                links.doi ||
                  links.arxiv ||
                  links.pdf ||
                  links.code ||
                  links.slides ||
                  links.poster
              );

            return (
              <li
                class="
                  rounded-lg border border-[#ffffff29] dark:border-white/10
                  bg-white/80 dark:bg-slate-900/80
                  p-6 backdrop-blur shadow-[0_4px_30px_rgba(0,0,0,0.1)]
                  transition hover:shadow-lg hover:-translate-y-0.5
                  intersect-once intersect-quarter intersect-no-queue
                  motion-safe:md:opacity-0 motion-safe:md:intersect:animate-fade
                "
                style={`animation-delay:${Math.min(i * 60 + 100, 480)}ms`}
              >
                {hasDetails ? (
                  <details class="group">
                    <summary class="list-none cursor-pointer">
                      <div class="relative">
                        {links.doi && (
                          <a
                            href={links.doi}
                            class="rounded-full border px-2.5 py-1 text-xs hover:bg-white/10 dark:border-white/10"
                            style="float:right;margin-left:12px;"
                            >DOI</a
                          >
                        )}
                        <h3 class="text-lg font-semibold leading-snug">
                          {data.title}
                        </h3>
                      </div>

                      <p class="mt-1 text-sm opacity-90">
                        {authorLine(data.authors)}
                        {data.venue ? <em> - {data.venue}</em> : ''}
                        {/* {data.type ? ` ¬∑ ${data.type}` : ''} */}
                        {data.year ? `(${data.year})` : ''}
                      </p>
                    </summary>

                    <div class="mt-3 fade-disclosure">
                      {data.abstract && (
                        <p class="text-sm leading-6 opacity-90">
                          <b>Abstract</b>:<br />
                          {data.abstract}
                        </p>
                      )}

                      {(links.arxiv ||
                        links.pdf ||
                        links.code ||
                        links.slides ||
                        links.poster ||
                        data.award) && (
                        <div class="mt-4 flex flex-wrap gap-2 text-xs">
                          {links.arxiv && (
                            <a
                              href={links.arxiv}
                              class="rounded-full border px-2.5 py-1 hover:bg-white/10"
                              >arXiv</a
                            >
                          )}
                          {links.pdf && (
                            <a
                              href={links.pdf}
                              class="rounded-full border px-2.5 py-1 hover:bg-white/10"
                              >PDF</a
                            >
                          )}
                          {links.code && (
                            <a
                              href={links.code}
                              class="rounded-full border px-2.5 py-1 hover:bg-white/10"
                              >Code</a
                            >
                          )}
                          {links.slides && (
                            <a
                              href={links.slides}
                              class="rounded-full border px-2.5 py-1 hover:bg-white/10"
                              >Slides</a
                            >
                          )}
                          {links.poster && (
                            <a
                              href={links.poster}
                              class="rounded-full border px-2.5 py-1 hover:bg-white/10"
                              >Poster</a
                            >
                          )}
                          {data.award && (
                            <span class="rounded-full border px-2.5 py-1"
                              >üèÖ {data.award}</span
                            >
                          )}
                        </div>
                      )}

                      {(() => {
                        const tags = toStringArray(data.tags);
                        return tags.length > 0 ? (
                          <div
                            class="mt-3 flex flex-wrap gap-2 text-[11px] opacity-80"
                          >
                            {tags.map((t) => (
                              <span class="rounded-full border px-2 py-0.5"
                                >{t}</span
                              >
                            ))}
                          </div>
                        ) : null;
                      })()}
                    </div>
                  </details>
                ) : (
                  <>
                    <div class="relative">
                      {links.doi && (
                        <a
                          href={links.doi}
                          class="rounded-full border px-2.5 py-1 text-xs hover:bg-white/10"
                          style="float:right;margin-left:12px;"
                          >DOI</a
                        >
                      )}
                      <h3 class="text-lg font-semibold leading-snug">
                        {data.title}
                      </h3>
                    </div>

                    <p class="mt-1 text-sm opacity-90">
                      {authorLine(data.authors)}
                      {data.venue ? ` ‚Äî ${data.venue}` : ''}
                      {data.type ? ` ¬∑ ${data.type}` : ''}
                      {data.year ? ` ¬∑ ${data.year}` : ''}
                    </p>

                    {data.abstract && (
                      <p class="mt-3 text-sm leading-6 opacity-90">{data.abstract}</p>
                    )}

                    {(links.arxiv ||
                      links.pdf ||
                      links.code ||
                      links.slides ||
                      links.poster ||
                      data.award) && (
                      <div class="mt-4 flex flex-wrap gap-2 text-xs">
                        {links.arxiv && (
                          <a
                            href={links.arxiv}
                            class="rounded-full border px-2.5 py-1 hover:bg-white/10"
                            >arXiv</a
                          >
                        )}
                        {links.pdf && (
                          <a
                            href={links.pdf}
                            class="rounded-full border px-2.5 py-1 hover:bg-white/10"
                            >PDF</a
                          >
                        )}
                        {links.code && (
                          <a
                            href={links.code}
                            class="rounded-full border px-2.5 py-1 hover:bg-white/10"
                            >Code</a
                          >
                        )}
                        {links.slides && (
                          <a
                            href={links.slides}
                            class="rounded-full border px-2.5 py-1 hover:bg-white/10"
                            >Slides</a
                          >
                        )}
                        {links.poster && (
                          <a
                            href={links.poster}
                            class="rounded-full border px-2.5 py-1 hover:bg-white/10"
                            >Poster</a
                          >
                        )}
                        {data.award && (
                          <span class="rounded-full border px-2.5 py-1"
                            >üèÖ {data.award}</span
                          >
                        )}
                      </div>
                    )}

                    {(() => {
                      const tags = toStringArray(data.tags);
                      return tags.length > 0 ? (
                        <div class="mt-3 flex flex-wrap gap-2 text-[11px] opacity-80">
                          {tags.map((t) => (
                            <span class="rounded-full border px-2 py-0.5">{t}</span>
                          ))}
                        </div>
                      ) : null;
                    })()}
                  </>
                )}
              </li>
            );
          })}
        </ul>
      </section>
    ))}
  </section>

  <!-- Minimal CSS -->
  <style>
    .pubs summary::-webkit-details-marker {
      display: none;
    }
    .pubs summary::marker {
      content: "";
    }
    .pubs details .fade-disclosure {
      will-change: opacity, transform, height;
    }
  </style>

  <!-- Script with slower opacity fade -->
  <script is:inline>
    (function () {
      var DURATION_HEIGHT = 520;
      var DURATION_OPACITY = 520; // slower fade
      var EASING = 'ease';

      function animateOpen(details, content) {
        if (!details.hasAttribute('open')) details.setAttribute('open', '');
        content.style.transition = 'none';
        content.style.overflow = 'hidden';
        content.style.height = '0px';
        content.style.opacity = '0';
        content.style.transform = 'translateY(-4px)';
        void content.offsetHeight;
        var target = content.scrollHeight + 'px';
        content.style.transition =
          'height ' + DURATION_HEIGHT + 'ms ' + EASING + ', ' +
          'opacity ' + DURATION_OPACITY + 'ms ' + EASING + ', ' +
          'transform ' + DURATION_HEIGHT + 'ms ' + EASING;
        content.style.height = target;
        content.style.opacity = '1';
        content.style.transform = 'translateY(0)';
        function done(e) {
          // Only finalize when the height animation completes
          if (e.target !== content || e.propertyName !== 'height') return;
          content.removeEventListener('transitionend', done);
          content.style.transition = 'none';
          content.style.height = 'auto';

          // Mark logical state so the next click will CLOSE
          details.dataset.collapsed = 'false';
          var s = details.querySelector('summary');
          if (s) s.setAttribute('aria-expanded', 'true');
        }
        content.addEventListener('transitionend', done);
      }

      
      function animateClose(details, content) {
        // lock current box
        content.style.transition = 'none';
        content.style.overflow = 'hidden';

        // use rendered height (more stable than scrollHeight on close)
        var startH = content.getBoundingClientRect().height;
        var startW = content.getBoundingClientRect().width; // optional: freeze width

        content.style.width  = startW + 'px';   // optional but helps on all cards
        content.style.height = startH + 'px';
        content.style.opacity = '1';
        content.style.transform = 'translateY(0)';
        void content.offsetHeight;

        // animate collapse (keep your timings/easing)
        content.style.transition =
          'height ' + DURATION_HEIGHT + 'ms ' + EASING + ', ' +
          'opacity ' + DURATION_OPACITY + 'ms ' + EASING + ', ' +
          'transform ' + DURATION_HEIGHT + 'ms ' + EASING;

        content.style.height = '0px';
        content.style.opacity = '0';
        content.style.transform = 'translateY(-4px)';

        function onEnd(e) {
          if (e.target !== content || e.propertyName !== 'height') return;
          content.removeEventListener('transitionend', onEnd);

          // IMPORTANT: do NOT remove 'open' ‚Äî leave <details> open permanently.
          // Just keep the content collapsed at height:0.
          requestAnimationFrame(function () {
            content.style.transition = 'none';
            content.style.width  = '';         // unfreeze width
            content.style.height = '0px';
            content.style.opacity = '0';
            content.style.transform = 'translateY(-4px)';

            // mark logical state for accessibility / next toggle
            details.dataset.collapsed = 'true';
            var summary = details.querySelector('summary');
            if (summary) summary.setAttribute('aria-expanded', 'false');
          });
        }
        content.addEventListener('transitionend', onEnd);
      }


      function setup(details) {
        var summary = details.querySelector('summary');
        var content = details.querySelector('.fade-disclosure');
        if (!summary || !content) return;

        var isOpen = details.hasAttribute('open');
        content.style.overflow = 'hidden';
        content.style.height = isOpen ? 'auto' : '0px';
        content.style.opacity = isOpen ? '1' : '0';
        content.style.transform = isOpen ? 'translateY(0)' : 'translateY(-4px)';

        
      summary.addEventListener('click', function (ev) {
        ev.preventDefault();
        // collapsed if height is 0 OR we marked it as collapsed
        var collapsed = details.dataset.collapsed === 'true' || content.offsetHeight === 0;
        if (collapsed) {
          animateOpen(details, content);
        } else {
          animateClose(details, content);
        }
      });

      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function () {
          document.querySelectorAll('.pubs details').forEach(setup);
        });
      } else {
        document.querySelectorAll('.pubs details').forEach(setup);
      }
    })();
  </script>
</PageLayout>
