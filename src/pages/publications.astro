---
import Layout from "~/layouts/PageLayout.astro";
import { getCollection } from "astro:content";

// Load & sort (newest first by addedAt/date/year)
const pubs = (await getCollection("publications"))
  .filter((p) => !p.data.draft)
  .sort((a, b) => {
    const ta = new Date(b.data.addedAt ?? b.data.date ?? `${b.data.year ?? 0}-01-01`).getTime();
    const tb = new Date(a.data.addedAt ?? a.data.date ?? `${a.data.year ?? 0}-01-01`).getTime();
    return ta - tb;
  });

// Helpers
const isInitial = (t: string) => /^[A-Za-z](\.)?$/.test(t.trim());
function formatAuthors(auth: string | string[] | undefined) {
  if (!auth) return "";
  const arr = Array.isArray(auth) ? auth : [auth];
  const norm = arr.map((a) =>
    a
      .replace(/\s+/g, " ")
      .trim()
      .replace(/\b([A-Za-z])\b\.?/g, "$1.") // ensure single-dot initials
  );
  if (norm.length <= 2) return norm.join(" and ");
  return norm.slice(0, -1).join(", ") + ", and " + norm[norm.length - 1];
}
const doiUrl = (doi?: string) =>
  doi ? `https://doi.org/${doi.replace(/^https?:\/\/(dx\.)?doi\.org\//, "")}` : undefined;
---

<Layout title="Publications" description="List of publications from our group">
  <section>
    <!-- Keep your own section/container classes as-is around here if you had them -->
    {pubs.map((p) => {
      const authors = formatAuthors(p.data.authors);
      const showDetails = Boolean(
        p.data.abstract || p.data.doi || p.data.external || p.data.href || p.data.venue
      );
      const _doi = doiUrl(p.data.doi);

      return (
        /* ⬇️ Put YOUR existing item wrapper classes on this <details> if you had any.
           If you had a fade on expand, keep those classes on the inner elements you already use.
           We do not set any colors/backgrounds/opacities here. */
        <details>
          {/* ⬇️ SUMMARY: paste your existing "collapsed row" markup INSIDE this summary.
              Do NOT change its classes; keep exactly what you had before so colors/fades remain.
              The only class added is list-none to hide the default marker. Remove if undesired. */}
          <summary class="list-none">
            {/* START: your original collapsed item content (title/authors/venue/year line, badge, etc.) */}
            <div>
              <div>
                <h3>{p.data.title}</h3>
                {p.data.badge && <span>{p.data.badge}</span>}
              </div>
              <div>
                {authors && <span>{authors}</span>}
                {(authors && (p.data.venue || p.data.year)) && <span> · </span>}
                {p.data.venue && <span>{p.data.venue}</span>}
                {p.data.venue && p.data.year && <span>, </span>}
                {p.data.year && <span>{p.data.year}</span>}
                {/* DOI intentionally hidden here */}
              </div>
            </div>
            {/* END: your original collapsed item content */}
          </summary>

          {/* ⬇️ DETAILS: shows when expanded. Add YOUR fade class here if you had one (e.g., animate-fadeIn).
              We do not add any style classes so your theme remains unchanged. */}
          {showDetails && (
            <div>
              {p.data.abstract && <p>{p.data.abstract}</p>}

              <div>
                {_doi && (
                  <a href={_doi} target="_blank" rel="noopener noreferrer">
                    DOI
                  </a>
                )}
                {p.data.external && (
                  <a href={p.data.external} target="_blank" rel="noopener noreferrer">
                    View paper
                  </a>
                )}
                {p.data.href && !p.data.external && <a href={p.data.href}>More details</a>}
              </div>
            </div>
          )}
        </details>
      );
    })}
  </section>
</Layout>
